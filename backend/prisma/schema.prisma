datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

/**
 * ==================== Enums ====================
 */

enum Role {
  USER
  VENDOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum ServiceStatus {
  DRAFT
  ACTIVE
  INACTIVE
}

enum EventType {
  PAGEVIEW
  CTA_CLICK
  MESSAGE

  VIEW_START
  VIEW_PING
  VIEW_END
}

enum VerifyIntent {
  USER
  VENDOR
}

// ðŸŽ¯ Marketing â€“ de la cine primesc comunicÄƒri
enum MarketingSourcePreference {
  NONE
  PLATFORM_ONLY
  FOLLOWED_VENDORS
  FOLLOWED_AND_PAST_PURCHASES
  ALL_VENDORS
}

// ðŸŽ¯ Marketing â€“ ce tipuri de conÈ›inut
enum MarketingTopic {
  RECOMMENDATIONS
  PROMOTIONS
  EVENTS
  REMINDERS
  FEEDBACK
}

enum InvoiceStatus {
  DRAFT
  UNPAID
  OVERDUE
  PAID
  CANCELLED
}

enum InvoiceDirection {
  PLATFORM_TO_VENDOR // facturi ArtFest â†’ vendor (comisioane, abonamente etc.)
  VENDOR_TO_CLIENT // facturi vendor â†’ client final (legate de comenzi)
}

enum InvoiceType {
  COMMISSION
  SUBSCRIPTION
  SHIPPING
  OTHER
}

enum CustomerType {
  PF
  PJ
}

enum MarketingAudience {
  ALL
  USERS
  VENDORS
}

enum MarketingCampaignStatus {
  DRAFT
  SENDING
  SENT
  FAILED
}

/**
 * ==================== User & Auth ====================
 */
model User {
  id           String @id @default(uuid())
  email        String @unique
  passwordHash String

  tokenVersion Int @default(0)

  // Nume normalizat
  firstName      String?
  lastName       String?
  phone          String?
  // Legacy full name (compatibilitate)
  name           String?
  // ðŸ‘‡ cÃ¢mpuri extra profil
  city           String?
  avatarUrl      String?
  preferences    Json?
  marketingOptIn Boolean  @default(false)
  role           Role     @default(USER)
  createdAt      DateTime @default(now())

  // status cont
  status UserStatus @default(ACTIVE)

  lastLoginAt          DateTime?
  lastPasswordChangeAt DateTime?
  locked               Boolean   @default(false)

  // inactivitate
  inactiveNotifiedAt  DateTime?
  scheduledDeletionAt DateTime?

  // ConsimÈ›Äƒminte / conformitate
  // (legal & marketing Ã®n UserConsent + UserMarketingPrefs)
  emailVerifiedAt         DateTime?
  emailVerificationTokens EmailVerificationToken[]

  // ðŸ‘‡ NOI cÃ¢mpuri pentru schimbare email cu confirmare
  emailChangeToken     String?
  emailChangeNewEmail  String?
  emailChangeExpiresAt DateTime?

  // RelaÈ›ii 1â€“1 / 1â€“n
  vendor              Vendor?
  passwordResetTokens PasswordResetToken[]
  Favorite            Favorite[]
  passwordHistories   PasswordHistory[]
  marketingPrefs      UserMarketingPrefs?
  vendorBlocks        UserVendorBlock[]

  // FOLLOW MAGAZIN (VendorService)
  ServiceFollow ServiceFollow[]

  // inverse

  // ðŸ”¹ recenzii de PRODUS
  reviews       Review[]
  ReviewHelpful ReviewHelpful[]
  ReviewReport  ReviewReport[]

  commentReports CommentReport[] @relation("CommentReportReporter")

  // ðŸ”¹ recenzii de MAGAZIN (Store*)
  storeReviews       StoreReview[]
  storeReviewHelpful StoreReviewHelpful[]
  storeReviewReports StoreReviewReport[]

  // ðŸ‘‡ nou: editÄƒri recenzii (audit)
  productReviewEditLogs ProductReviewEditLog[]
  storeReviewEditLogs   StoreReviewEditLog[]

  comments            Comment[]
  cartItems           CartItem[]
  UserConsent         UserConsent[]
  supportTickets      SupportTicket[]
  supportMessages     SupportMessage[]
  supportReads        SupportRead[]
  MessageThread       MessageThread[]
  Message             Message[]
  Notification        Notification[]
  inactiveLogs        InactiveUserLog[]
  inactiveWarningLogs InactiveWarningLog[]
  loginAttempts       LoginAttempt[]

  marketingCampaigns MarketingCampaign[]
  // ðŸ‘‡ nou â€“ relaÈ›ia cu Order
  orders             Order[]

  @@index([emailChangeToken])
}

model InactiveUserLog {
  id        String   @id @default(uuid())
  userId    String
  email     String?
  deletedAt DateTime @default(now())
  reason    String   @default("INACTIVE_CLEANUP")

  hadOrders           Boolean   @default(false)
  monthsInactive      Int?
  lastLoginAt         DateTime?
  createdAt           DateTime?
  scheduledDeletionAt DateTime?

  meta Json?

  user User? @relation(fields: [userId], references: [id], onDelete: NoAction)

  @@index([userId])
}

model InactiveWarningLog {
  id           String   @id @default(uuid())
  userId       String?
  email        String?
  sentAt       DateTime @default(now())
  status       String
  errorMessage String?

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  tokenHash String    @unique
  createdAt DateTime  @default(now())
  expiresAt DateTime
  usedAt    DateTime?

  @@index([userId, expiresAt])
}

model PasswordHistory {
  id           String   @id @default(cuid())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  passwordHash String
  createdAt    DateTime @default(now())

  @@index([userId, createdAt])
}

model LoginAttempt {
  id     String  @id @default(cuid())
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId String?

  email String?

  success   Boolean
  ip        String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([email, createdAt])
  @@index([success, createdAt])
}

model EmailVerificationToken {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  tokenHash String    @unique
  purpose   String    @default("verify_email")
  createdAt DateTime  @default(now())
  expiresAt DateTime
  usedAt    DateTime?

  intent VerifyIntent @default(USER)

  @@index([userId, expiresAt])
  @@index([purpose])
}

/**
 * ==================== Marketing preferences ====================
 */

model UserMarketingPrefs {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  marketingOptIn   Boolean                   @default(false)
  sourcePreference MarketingSourcePreference @default(PLATFORM_ONLY)
  topics           MarketingTopic[]

  emailEnabled Boolean @default(true)
  smsEnabled   Boolean @default(false)
  pushEnabled  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MarketingCampaign {
  id        String  @id @default(cuid())
  subject   String
  preheader String?
  bodyHtml  String

  audience MarketingAudience
  status   MarketingCampaignStatus @default(SENT)

  // cÃ¢È›i destinatari au fost vizaÈ›i (dupÄƒ filtrare)
  targetCount Int @default(0)
  // cÃ¢È›i emailuri am trimis efectiv (dupÄƒ erori etc.)
  sentCount   Int @default(0)

  testEmail String? // dacÄƒ a fost campanie trimisÄƒ DOAR ca test

  createdAt DateTime  @default(now())
  sentAt    DateTime?

  createdById String? // admin user
  createdBy   User?   @relation(fields: [createdById], references: [id], onDelete: SetNull)
}

model UserVendorBlock {
  userId    String
  vendorId  String
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@id([userId, vendorId])
  @@index([vendorId, userId])
}

/**
 * ==================== Vendor & Billing ====================
 */
model Vendor {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  displayName String
  about       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  logoUrl              String?
  coverUrl             String?
  phone                String?
  email                String?
  website              String?
  socials              Json?
  address              String?
  delivery             String[]
  city                 String?
  citySlug             String?   @db.VarChar(64)
  // declaraÈ›ie pe proprie rÄƒspundere cÄƒ este entitate juridicÄƒ
  entitySelfDeclared   Boolean   @default(false)
  entitySelfDeclaredAt DateTime?

  billing VendorBilling?

productDeclaration VendorProductDeclaration?

  services      VendorService[]
  subscriptions VendorSubscription[]

  visitors         Visitor[]
  events           Event[]
  searches         Search[]
  VendorAcceptance VendorAcceptance[]
  ReviewReply      ReviewReply[]
  shipments        Shipment[]

  // ðŸ”¹ recenzii de MAGAZIN (profil)
  storeReviews       StoreReview[]
  storeReviewReplies StoreReviewReply[]
  storeRatingStats   StoreRatingStats?

  supportTickets SupportTicket[]
  MessageThread  MessageThread[]
  Notification   Notification[]
  blocks         UserVendorBlock[]
  invoices       Invoice[]

  @@index([isActive], name: "vendor_isActive_idx")
  @@index([citySlug], name: "vendor_citySlug_idx")
}

model VendorProductDeclaration {
  id       String @id @default(cuid())
  vendor   Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId String @unique

  // versiunea textului de declaraÈ›ie pe care o foloseÈ™ti Ã®n UI / fiÈ™ier
  version String  @default("1.0.0")

  // opÈ›ional: snapshot al textului la momentul acceptÄƒrii
  text      String?
  acceptedAt DateTime @default(now())

  // pentru audit (opÈ›ional)
  ip String?
  ua String?

  meta Json?

  @@index([vendorId])
}

model VendorBilling {
  id       String @id @default(uuid())
  vendor   Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId String @unique

  legalType     String
  vendorName    String
  companyName   String
  cui           String
  regCom        String
  address       String
  iban          String
  bank          String
  email         String
  contactPerson String
  phone         String

  // ðŸ”¹ TVA â€“ ce declarÄƒ vendorul Ã®n formular
  vatStatus                    String?   @db.VarChar(32) // "payer" | "non_payer"
  vatRate                      String?   @db.VarChar(8) // "19" | "9" | "5" | "0"
  vatResponsibilityConfirmed   Boolean   @default(false)
  vatLastResponsibilityConfirm DateTime?

  // ðŸ”¹ TVA â€“ informaÈ›ii rezultate din ANAF
  tvaActive     Boolean?
  tvaVerifiedAt DateTime?
  tvaSource     String?
  anafName      String?
  anafAddress   String?

  tvaRegStart DateTime?
  tvaRegEnd   DateTime?
  inactiv     Boolean?
  inactivFrom DateTime?
  insolvent   Boolean?
  splitTva    Boolean?
  anafPayload Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cui])
  @@index([email])
}

/**
 * ==================== Catalog servicii ====================
 */

model ServiceType {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  fields    Json?
  createdAt DateTime @default(now())

  vendorServices VendorService[]
}

model VendorService {
  id       String      @id @default(uuid())
  vendor   Vendor      @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId String
  type     ServiceType @relation(fields: [typeId], references: [id])
  typeId   String

  title          String?
  description    String?
  basePriceCents Int?
  currency       String   @default("EUR")
  city           String?
  coverageAreas  String[]
  mediaUrls      String[]
  attributes     Json?

  profile  ServiceProfile?
  products Product[]

  // FOLLOWERS pe magazin
  ServiceFollow ServiceFollow[]

  status    ServiceStatus @default(DRAFT)
  isActive  Boolean       @default(false)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([vendorId, typeId], name: "vendor_type_unique")
  @@index([vendorId, typeId])
  @@index([typeId, isActive, status, city], name: "vendor_service_filters_idx")
}

model ServiceProfile {
  id        String        @id @default(uuid())
  service   VendorService @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  serviceId String        @unique

  displayName String?
  slug        String?  @unique
  logoUrl     String?
  coverUrl    String?
  phone       String?
  email       String?
  website     String?
  socials     Json?
  address     String?
  delivery    String[]
  about       String?
  city        String?
  citySlug    String?  @db.VarChar(64)

  shortDescription String? @db.VarChar(160)
  tagline          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ðŸ”¹ nou â€“ pt /stores & filtrare dupÄƒ oraÈ™
  @@index([city], name: "service_profile_city_idx")
  @@index([citySlug], name: "service_profile_citySlug_idx")
}

/**
 * ==================== FOLLOW pe magazin ====================
 */

model ServiceFollow {
  userId    String
  serviceId String
  createdAt DateTime @default(now())

  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  service VendorService @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@id([userId, serviceId])
  @@index([serviceId, createdAt])
}

/**
 * ==================== Subscriptions ====================
 */

enum PlanInterval {
  month
  year
}

enum SubscriptionStatus {
  pending
  active
  canceled
  canceled_at_period_end
  past_due
  unpaid
  expired
}

model SubscriptionPlan {
  id         String       @id @default(uuid())
  code       String       @unique
  name       String
  priceCents Int
  currency   String       @default("RON")
  interval   PlanInterval @default(month)
  features   String[]
  isActive   Boolean      @default(true)
  popular    Boolean      @default(false)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  subscriptions VendorSubscription[]

  @@index([isActive, priceCents])
}

model VendorSubscription {
  id       String           @id @default(uuid())
  vendor   Vendor           @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId String
  plan     SubscriptionPlan @relation(fields: [planId], references: [id])
  planId   String

  status  SubscriptionStatus @default(pending)
  startAt DateTime           @default(now())
  endAt   DateTime
  extRef  String?
  meta    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vendorId, status, endAt])
  @@index([extRef])
}

enum ProductAvailability {
  READY
  MADE_TO_ORDER
  PREORDER
  SOLD_OUT
}

model Product {
  id        String        @id @default(uuid())
  service   VendorService @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  serviceId String

  title       String
  description String?
  priceCents  Int
  currency    String   @default("RON")
  images      String[]
  isActive    Boolean  @default(true)

  category String? @db.VarChar(64)
  color    String? @db.VarChar(32)

  availability         ProductAvailability @default(READY)
  leadTimeDays         Int?
  readyQty             Int?                @default(0)
  acceptsCustom        Boolean             @default(false)
  nextShipDate         DateTime?
  limitedEditionOf     Int?
  limitedEditionNumber Int?
  isHidden             Boolean             @default(false)

  materialMain     String?  @db.VarChar(120)
  technique        String?  @db.VarChar(160)
  styleTags        String[]
  occasionTags     String[]
  dimensions       String?  @db.VarChar(120)
  careInstructions String?
  specialNotes     String?

  popularityScore Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Favorite Favorite[]

  reviews            Review[]
  comments           Comment[]
  cartItems          CartItem[]
  ProductRatingStats ProductRatingStats[]

  // ðŸ”¹ index-uri existente
  @@index([serviceId, isActive, createdAt])
  @@index([category])
  @@index([isHidden, isActive, availability, createdAt])
  @@index([priceCents])
  // ðŸ”¹ index-uri noi pentru filtrele din /products
  @@index([color], name: "product_color_idx")
  @@index([materialMain], name: "product_material_idx")
  @@index([technique], name: "product_technique_idx")
  @@index([leadTimeDays], name: "product_leadTime_idx")
  @@index([acceptsCustom], name: "product_acceptsCustom_idx")
  // ðŸ”¹ index compus exact pe pattern-ul de filtre cel mai folosit
  @@index([isActive, isHidden, category, availability, priceCents, createdAt], name: "product_filters_category_price_created")
}

model Favorite {
  userId    String
  productId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([userId, productId])
  @@index([userId, createdAt, productId])
}

/**
 * ==================== Reviews / Comments / Cart ====================
 */
model Review {
  id        String       @id @default(cuid())
  productId String
  product   Product      @relation(fields: [productId], references: [id])
  userId    String
  user      User         @relation(fields: [userId], references: [id])
  rating    Int
  comment   String?
  verified  Boolean      @default(false)
  status    ReviewStatus @default(PENDING)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  editLogs ProductReviewEditLog[]
  images   ReviewImage[]
  helpful  ReviewHelpful[]
  reply    ReviewReply?
  reports  ReviewReport[]

  @@unique([productId, userId], name: "productId_userId")
}

model ReviewImage {
  id        String   @id @default(cuid())
  reviewId  String
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  url       String
  createdAt DateTime @default(now())
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  HIDDEN // ascunsÄƒ din public, dar pÄƒstratÄƒ Ã®n DB
  DELETED // marcatÄƒ ca È™tearsÄƒ pentru audit, dar nu afiÈ™atÄƒ
}

model ReviewHelpful {
  id        String   @id @default(cuid())
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reviewId  String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  createdAt DateTime @default(now())

  @@unique([reviewId, userId])
  @@index([userId, createdAt])
}

model ReviewReply {
  id        String   @id @default(cuid())
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reviewId  String   @unique
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId  String
  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ReviewReport {
  id         String   @id @default(cuid())
  review     Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reviewId   String
  reporter   User     @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  reporterId String
  reason     String
  createdAt  DateTime @default(now())

  @@index([reviewId, createdAt])
}

/// ==================== Store / Profile Reviews ====================

model StoreReview {
  id       String @id @default(cuid())
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  rating   Int
  comment  String?
  verified Boolean      @default(false)
  status   ReviewStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  helpful  StoreReviewHelpful[]
  reply    StoreReviewReply?
  reports  StoreReviewReport[]
  editLogs StoreReviewEditLog[]

  @@unique([vendorId, userId], name: "vendorId_userId")
  @@index([vendorId])
  @@index([userId, createdAt])
}

model StoreReviewHelpful {
  id       String      @id @default(cuid())
  reviewId String
  review   StoreReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([reviewId, userId])
  @@index([userId, createdAt])
}

model StoreReviewReply {
  id       String      @id @default(cuid())
  reviewId String      @unique
  review   StoreReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model StoreReviewReport {
  id       String      @id @default(cuid())
  reviewId String
  review   StoreReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  reporterId String
  reporter   User   @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  reason    String
  createdAt DateTime @default(now())

  @@index([reviewId, createdAt])
}

model StoreRatingStats {
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId  String   @id
  avg       Decimal  @db.Decimal(4, 2)
  c1        Int      @default(0)
  c2        Int      @default(0)
  c3        Int      @default(0)
  c4        Int      @default(0)
  c5        Int      @default(0)
  updatedAt DateTime @updatedAt
}

model ProductRatingStats {
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String   @id
  avg       Decimal  @db.Decimal(4, 2)
  c1        Int      @default(0)
  c2        Int      @default(0)
  c3        Int      @default(0)
  c4        Int      @default(0)
  c5        Int      @default(0)
  updatedAt DateTime @updatedAt
}

model Comment {
  id        String   @id @default(uuid())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  text      String
  parentId  String?
  createdAt DateTime @default(now())

  // ðŸ‘‡ nou â€“ raportÄƒri
  reports CommentReport[]

  @@index([productId])
  @@index([userId])
}

model CommentReport {
  id String @id @default(cuid())

  comment   Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  commentId String

  reporter   User   @relation("CommentReportReporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reporterId String

  reason    String
  createdAt DateTime @default(now())
}

model CartItem {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Restrict)
  productId String
  qty       Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId], name: "userId_productId")
  @@index([userId])
  @@index([userId, createdAt])
}

model Visitor {
  id       String @id @default(uuid())
  vendor   Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId String

  productId String?
  source    String?
  ref       String?

  city      String?
  ipHash    String?
  userAgent String?

  note      String?
  contacted Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([vendorId, createdAt])
  @@index([vendorId, contacted])
}

model Event {
  id        String    @id @default(cuid())
  vendorId  String
  type      EventType
  createdAt DateTime  @default(now())
  pageUrl   String?
  ctaLabel  String?
  referrer  String?
  sessionId String?
  userAgent String?
  viewId    String?
  Vendor    Vendor    @relation(fields: [vendorId], references: [id])

  @@index([vendorId, createdAt])
  @@index([vendorId, type, createdAt])
  @@index([vendorId, pageUrl, createdAt])
  @@index([vendorId, sessionId, viewId, createdAt])
}

model Search {
  id        String   @id @default(cuid())
  vendorId  String
  query     String
  hits      Int      @default(1)
  createdAt DateTime @default(now())
  Vendor    Vendor   @relation(fields: [vendorId], references: [id])
  userId    String?
  city      String?
  filters   Json?
  results   Int?

  @@index([vendorId, createdAt])
}

enum ConsentDoc {
  TOS
  PRIVACY_ACK
  MARKETING_EMAIL_OPTIN
}

model UserConsent {
  id       String     @id @default(cuid())
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   String
  document ConsentDoc
  version  String
  checksum String?
  givenAt  DateTime   @default(now())
  ip       String?
  ua       String?

  @@index([userId, document])
}

enum VendorDoc {
  VENDOR_TERMS
  SHIPPING_ADDENDUM
  RETURNS_POLICY_ACK
}

model VendorPolicy {
  id          String    @id @default(cuid())
  document    VendorDoc
  title       String
  url         String
  version     String
  checksum    String?
  isRequired  Boolean   @default(true)
  isActive    Boolean   @default(true)
  publishedAt DateTime  @default(now())

  @@unique([document, version])
  @@index([document, isActive])
}

model VendorAcceptance {
  id         String    @id @default(cuid())
  vendor     Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId   String
  document   VendorDoc
  version    String
  checksum   String?
  acceptedAt DateTime  @default(now())

  @@unique([vendorId, document, version], name: "vendorId_document_version")
  @@index([vendorId, document, acceptedAt])
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  FULFILLED
}

enum ShipmentStatus {
  PENDING
  AWB
  IN_TRANSIT
  DELIVERED
  RETURNED
  PREPARING
  READY_FOR_PICKUP
  PICKUP_SCHEDULED
}

enum PaymentMethod {
  COD
  CARD
}

enum ShippingMethod {
  COURIER
  LOCKER
}

model Order {
  id              String        @id @default(cuid())
  userId          String
  status          OrderStatus   @default(PENDING)
  paymentMethod   PaymentMethod
  currency        String        @default("RON")
  subtotal        Decimal       @db.Decimal(10, 2)
  shippingTotal   Decimal       @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  shippingAddress Json
  customerType    CustomerType  @default(PF)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  vendorNotes     String?
  adminNotes      String?

  shipments      Shipment[]
  messageThreads MessageThread[]

  // ðŸ”¹ NOI: legÄƒtura cu facturile vendor â†’ client
  invoices Invoice[]

  // ðŸ”¹ opÈ›ional, pentru afiÈ™are rapidÄƒ Ã®n UI (o singurÄƒ facturÄƒ principalÄƒ)
  invoiceNumber String?   @db.VarChar(64)
  invoiceDate   DateTime?

  // ðŸ‘‡ nou â€“ relaÈ›ia spre User
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model Shipment {
  id       String         @id @default(cuid())
  orderId  String
  vendorId String
  method   ShippingMethod @default(COURIER)
  lockerId String?
  price    Decimal        @default(0) @db.Decimal(10, 2)
  status   ShipmentStatus @default(PENDING)

  courierProvider String?
  courierService  String?
  awb             String?
  labelUrl        String?
  trackingUrl     String?

  pickupDate        DateTime?
  pickupSlotStart   DateTime?
  pickupSlotEnd     DateTime?
  pickupScheduledAt DateTime?

  consents Json?
  parcels  Int?
  weightKg Decimal? @db.Decimal(7, 2)
  lengthCm Int?
  widthCm  Int?
  heightCm Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vendor Vendor? @relation(fields: [vendorId], references: [id])

  order Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  items ShipmentItem[]

  @@index([orderId])
  @@index([vendorId])
  @@index([status, pickupDate])
}

model ShipmentItem {
  id         String  @id @default(cuid())
  shipmentId String
  productId  String
  title      String
  qty        Int
  price      Decimal @db.Decimal(10, 2)

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId])
  @@index([productId])
}

/**
 * ==================== Support, messaging, notifications ====================
 */

enum TicketStatus {
  OPEN
  PENDING
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
}

enum SupportAudience {
  USER
  VENDOR
  GUEST
}

model SupportTicket {
  id String @id @default(cuid())

  requester   User?   @relation(fields: [requesterId], references: [id], onDelete: Cascade)
  requesterId String?

  vendor   Vendor? @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  vendorId String?

  subject  String
  category String         @default("general")
  status   TicketStatus   @default(OPEN)
  priority TicketPriority @default(MEDIUM)

  audience SupportAudience @default(VENDOR)

  requesterName  String?
  requesterEmail String?

  lastMessageAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  messages    SupportMessage[]
  attachments SupportAttachment[]
  reads       SupportRead[]
}

model SupportMessage {
  id       String        @id @default(cuid())
  ticket   SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  ticketId String

  author   User?   @relation(fields: [authorId], references: [id], onDelete: SetNull)
  authorId String?
  system   Boolean @default(false)

  body      String
  createdAt DateTime @default(now())

  attachments SupportAttachment[]

  @@index([ticketId, createdAt])
}

model SupportAttachment {
  id        String          @id @default(cuid())
  ticket    SupportTicket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  ticketId  String
  message   SupportMessage? @relation(fields: [messageId], references: [id], onDelete: SetNull)
  messageId String?
  filename  String
  url       String
  mime      String?
  size      Int?
  createdAt DateTime        @default(now())

  @@index([ticketId, createdAt])
}

model SupportRead {
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  ticketId   String
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  lastReadAt DateTime      @default(now())

  @@id([ticketId, userId])
  @@index([userId, lastReadAt])
}

model SupportFaq {
  id        String   @id @default(cuid())
  q         String
  a         String
  tags      String[]
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([isActive, createdAt])
}

enum MessageAuthorType {
  VENDOR
  VISITOR
  USER
}

enum LeadStatus {
  NEW
  IN_DISCUSSION
  OFFER_SENT
  RESERVED
  LOST
}

model MessageThread {
  id String @id @default(cuid())

  vendor   Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId String

  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId String?

  contactName  String?
  contactEmail String?
  contactPhone String?

  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  archived       Boolean @default(false)
  archivedByUser Boolean @default(false)

  lastMsg String?
  lastAt  DateTime?

  vendorLastReadAt  DateTime?
  visitorLastReadAt DateTime?
  userLastReadAt    DateTime?

  eventDate     DateTime?
  eventType     String?
  eventLocation String?
  budgetMin     Int?
  budgetMax     Int?
  leadStatus    LeadStatus @default(NEW)
  tags          String[]
  followUpAt    DateTime?
  internalNote  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages      Message[]
  notifications Notification[] // ðŸ‘ˆ relaÈ›ia inversÄƒ

  @@index([vendorId, archived, lastAt])
  @@index([vendorId, lastAt])
  @@index([userId])
  @@index([contactEmail])
  @@index([contactPhone])
  @@index([orderId])
  @@index([vendorId, eventDate])
  @@index([vendorId, leadStatus])
}

model Message {
  id       String        @id @default(cuid())
  thread   MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  threadId String

  authorType   MessageAuthorType
  authorUser   User?             @relation(fields: [authorUserId], references: [id], onDelete: SetNull)
  authorUserId String?

  authorName String?
  body       String
  createdAt  DateTime @default(now())

  attachments MessageAttachment[]

  @@index([threadId, createdAt])
}

model MessageAttachment {
  id        String   @id @default(cuid())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId String
  filename  String
  url       String
  mime      String?
  size      Int?
  createdAt DateTime @default(now())

  @@index([messageId])
}

enum NotificationType {
  message
  order
  billing
  system
  email
  followup // ðŸ‘ˆ nou â€“ pentru remindere de follow-up lead
  support
  invoice
  shipping
}

model Notification {
  id String @id @default(cuid())

  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String?

  vendor   Vendor? @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  vendorId String?

  // ðŸ‘‡ legÄƒturÄƒ opÈ›ionalÄƒ cu un thread de mesaje (lead / conversaÈ›ie)
  thread   MessageThread? @relation(fields: [threadId], references: [id])
  threadId String?

  type  NotificationType @default(system)
  title String
  body  String?
  link  String?

  readAt   DateTime?
  archived Boolean   @default(false)

  meta Json?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([userId, readAt, archived])
  @@index([vendorId, createdAt])
  @@index([vendorId, readAt, archived])
  @@index([vendorId, threadId, type])
}

model Invoice {
  id       String @id @default(cuid())
  vendor   Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId String

  // platformÄƒ â†’ vendor sau vendor â†’ client
  direction InvoiceDirection
  type      InvoiceType      @default(OTHER)

  // pentru facturi ArtFest â†’ vendor (abonamente, comisioane etc.)
  // (nu e obligatoriu sÄƒ-l foloseÈ™ti)
  periodFrom DateTime?
  periodTo   DateTime?

  // legÄƒturÄƒ cu o comandÄƒ (pentru facturile vendor â†’ client)
  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  series    String?   @db.VarChar(16)
  number    String    @db.VarChar(64)
  issueDate DateTime
  dueDate   DateTime?
  currency  String    @default("RON") @db.VarChar(8)
  notes     String?

  // date client (pentru VENDOR_TO_CLIENT)
  clientName    String?
  clientEmail   String?
  clientPhone   String?
  clientAddress String?

  totalNet   Decimal @db.Decimal(12, 2)
  totalVat   Decimal @db.Decimal(12, 2)
  totalGross Decimal @db.Decimal(12, 2)

  status InvoiceStatus @default(UNPAID)

  pdfUrl     String?
  externalId String? // ID Ã®n SmartBill / FGO / alt provider, dacÄƒ vei integra
  meta       Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lines InvoiceLine[]

  @@unique([vendorId, number], name: "vendor_invoice_number_unique")
  @@index([vendorId, direction, status, issueDate])
  @@index([orderId])
}

model InvoiceLine {
  id        String  @id @default(cuid())
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId String

  description String
  quantity    Int
  unitNet     Decimal @db.Decimal(10, 2)
  vatRate     Decimal @db.Decimal(5, 2)

  totalNet   Decimal @db.Decimal(10, 2)
  totalVat   Decimal @db.Decimal(10, 2)
  totalGross Decimal @db.Decimal(10, 2)

  // legÄƒturi opÈ›ionale, dacÄƒ vei avea OrderItem sau vrei referinÈ›Äƒ la product
  orderItemId String?
  productId   String?

  createdAt DateTime @default(now())

  @@index([invoiceId])
}

/// Istoric modificÄƒri pentru recenzii de PRODUS
model ProductReviewEditLog {
  id String @id @default(cuid())

  review   Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reviewId String

  // Cine a fÄƒcut modificarea (user / admin / vendor ca user)
  editor   User?   @relation(fields: [editorId], references: [id], onDelete: SetNull)
  editorId String?

  oldRating  Int?
  newRating  Int?
  oldComment String?
  newComment String?

  reason String?

  createdAt DateTime @default(now())

  @@index([reviewId, createdAt])
  @@index([editorId, createdAt])
}

/// Istoric modificÄƒri pentru recenzii de MAGAZIN (profil)
model StoreReviewEditLog {
  id String @id @default(cuid())

  review   StoreReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reviewId String

  editor   User?   @relation(fields: [editorId], references: [id], onDelete: SetNull)
  editorId String?

  oldRating  Int?
  newRating  Int?
  oldComment String?
  newComment String?

  reason String?

  createdAt DateTime @default(now())

  @@index([reviewId, createdAt])
  @@index([editorId, createdAt])
}

model CityDictionary {
  // slug normalizat, fÄƒrÄƒ diacritice (ex: "bacau")
  slug String @id @db.VarChar(64)

  // cum vrei sÄƒ aparÄƒ la clienÈ›i (ex: "BacÄƒu")
  canonicalLabel String @db.VarChar(128)

  // eventual pentru audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
